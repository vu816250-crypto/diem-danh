<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ƒêi·ªÉm danh GPS</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: linear-gradient(135deg, #111827, #1f2937);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
    color: #fff;
  }

  .card {
    background: #0f172a;
    width: 100%;
    max-width: 420px;
    padding: 22px;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0,0,0,.4);
  }

  h1 {
    text-align: center;
    margin: 0 0 6px;
  }

  .sub {
    text-align: center;
    font-size: 13px;
    color: #cbd5f5;
    margin-bottom: 18px;
  }

  input, button {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
  }

  input {
    background: #020617;
    color: #fff;
    border: 1px solid #334155;
  }

  button {
    font-weight: bold;
    cursor: pointer;
  }

  .btn-main {
    background: #2563eb;
    color: white;
  }

  .btn-sub {
    background: #1e293b;
    color: #e5e7eb;
  }

  #output {
    margin-top: 14px;
    background: #020617;
    padding: 12px;
    border-radius: 10px;
    white-space: pre-line;
    font-size: 14px;
  }

  .footer {
    margin-top: 14px;
    font-size: 12px;
    text-align: center;
    color: #94a3b8;
  }
</style>
</head>

<body>
<div class="card">
  <h1>üìç ƒêI·ªÇM DANH GPS</h1>
  <div class="sub">M·ªói ng√†y m·ªói m√°y ch·ªâ ƒëi·ªÉm danh 1 l·∫ßn</div>

  <input id="name" placeholder="Nh·∫≠p h·ªç v√† t√™n">

  <button class="btn-main" onclick="checkIn()">üìç ƒêi·ªÉm danh</button>
  <button class="btn-sub" onclick="showList()">üìã Xem danh s√°ch</button>
  <button class="btn-sub" onclick="exportCSV()">‚¨áÔ∏è Xu·∫•t danh s√°ch (Excel)</button>

  <div id="output"></div>

  <div class="footer">Attendance GPS System</div>
</div>

<script>
/* ========== C·∫§U H√åNH ========== */
// üìç To·∫° ƒë·ªô l·ªõp (S·ª¨A)
const TARGET_LAT = 16.460935;
const TARGET_LNG = 107.602060;

// üìè B√°n k√≠nh cho ph√©p (m)
const ALLOW_RADIUS = 150;

// ‚è∞ GI·ªú + PH√öT ƒêI·ªÇM DANH (CH·ªà C·∫¶N CH·ªàNH CH·ªñ N√ÄY)
const START_HOUR = 23;
const START_MIN  = 0;

const END_HOUR   = 2;
const END_MIN    = 15;
/* ============================== */

/* ========= GOOGLE SHEET API ========= */
const API_URL = "https://script.google.com/macros/s/AKfycbxxxxxxxx/exec";

function submitAttendance(data) {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(data),
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(res => res.text())
  .then(msg => {
    alert("‚úÖ ƒêi·ªÉm danh th√†nh c√¥ng");
  })
  .catch(err => {
    alert("‚ùå L·ªói g·ª≠i d·ªØ li·ªáu l√™n Google Sheet");
    console.error(err);
  });
}
/* ============================ */
// üîë Key theo NG√ÄY (t·ª± reset m·ªói ng√†y)
const today = new Date().toLocaleDateString("vi-VN");
const CHECK_KEY = "checked_in_" + today;
const LIST_KEY  = "attendance_list_" + today;

/* ===== KI·ªÇM TRA TH·ªúI GIAN ===== */
function isWithinTime() {
  const now = new Date();
  const nowMin = now.getHours() * 60 + now.getMinutes();
  const startMin = START_HOUR * 60 + START_MIN;
  const endMin = END_HOUR * 60 + END_MIN;
  return nowMin >= startMin && nowMin <= endMin;
}

/* ===== T√çNH KHO·∫¢NG C√ÅCH ===== */
function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat/2) ** 2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon/2) ** 2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ===== L∆ØU DANH S√ÅCH ===== */
function saveAttendance(name, time, distance) {
  const list = JSON.parse(localStorage.getItem(LIST_KEY) || "[]");
  list.push({ name, time, distance });
  localStorage.setItem(LIST_KEY, JSON.stringify(list));
}

/* ===== ƒêI·ªÇM DANH ===== */
function checkIn() {
  const output = document.getElementById("output");
  const name = document.getElementById("name").value.trim();

  if (!name) {
    output.textContent = "‚ùå Vui l√≤ng nh·∫≠p h·ªç t√™n";
    return;
  }

  if (!isWithinTime()) {
    output.textContent = "‚õî Ngo√†i th·ªùi gian ƒëi·ªÉm danh";
    return;
  }

  if (localStorage.getItem(CHECK_KEY)) {
    output.textContent = "‚ö†Ô∏è M√°y n√†y ƒë√£ ƒëi·ªÉm danh h√¥m nay";
    return;
  }

  if (!navigator.geolocation) {
    output.textContent = "‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS";
    return;
  }

  output.textContent = "‚è≥ ƒêang l·∫•y v·ªã tr√≠...";

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const acc = pos.coords.accuracy;

    const dist = calcDistance(lat, lng, TARGET_LAT, TARGET_LNG);
    const timeStr = new Date().toLocaleString("vi-VN");

    let text =
      `üë§ ${name}\n` +
      `‚è∞ ${timeStr}\n` +
      `üìè ${dist.toFixed(1)} m\n` +
      `üéØ Accuracy: ${acc.toFixed(1)} m\n`;

    if (dist <= ALLOW_RADIUS) {
      text += "\n‚úÖ ƒêI·ªÇM DANH TH√ÄNH C√îNG";
      localStorage.setItem(CHECK_KEY, "1");
      saveAttendance(name, timeStr, dist.toFixed(1));
    } else {
      text += "\n‚ùå B·∫°n kh√¥ng ·ªü trong khu v·ª±c l·ªõp";
    }

    output.textContent = text;
  }, () => {
    output.textContent = "‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠ GPS";
  }, {
    enableHighAccuracy: true,
    timeout: 10000
  });
}

/* ===== XEM DANH S√ÅCH ===== */
function showList() {
  const list = JSON.parse(localStorage.getItem(LIST_KEY) || "[]");
  if (list.length === 0) {
    alert("‚ùå Ch∆∞a c√≥ ai ƒëi·ªÉm danh");
    return;
  }

  let text = "üìã DANH S√ÅCH ƒêI·ªÇM DANH\n\n";
  list.forEach((s, i) => {
    text += `${i+1}. ${s.name}\n‚è∞ ${s.time}\nüìè ${s.distance} m\n\n`;
  });

  alert(text);
}

/* ===== XU·∫§T CSV (EXCEL) ===== */
function exportCSV() {
  const list = JSON.parse(localStorage.getItem(LIST_KEY) || "[]");
  if (list.length === 0) {
    alert("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t");
    return;
  }

  let csv = "STT,H·ªç t√™n,Th·ªùi gian,Kho·∫£ng c√°ch (m)\n";
  list.forEach((s, i) => {
    csv += `${i+1},"${s.name}","${s.time}",${s.distance}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `diem_danh_${today}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>